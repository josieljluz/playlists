# ===================================================================
# ğŸ“Œ WORKFLOW: deploy.yml (TURBO MODE - Otimizado para performance)
# ===================================================================

name: ğŸš€ Turbo Deploy to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 11 * * *'  # 8h BRT / 11h UTC

# ConfiguraÃ§Ãµes de ambiente otimizadas
env:
  NODE_ENV: production
  DEPLOY_ENV: github-pages
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.10'

# PermissÃµes granulares para melhor seguranÃ§a
permissions:
  contents: write
  pages: write
  id-token: write
  actions: read  # Permite ler status de outras aÃ§Ãµes

jobs:
  turbo-deploy:
    name: ğŸ—ï¸ Build & Deploy (Turbo Mode)
    runs-on: ubuntu-latest
    environment: 
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    # EstratÃ©gia de matriz para paralelizaÃ§Ã£o
    strategy:
      matrix:
        setup: ['python', 'node']
      fail-fast: false
    
    steps:
      # 1ï¸âƒ£ Checkout ultra-rÃ¡pido com sparse-checkout
      - name: ğŸ›’ Checkout repository (Turbo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Apenas o commit atual
          sparse-checkout: |
            /*
            !.github/workflows/
            !node_modules/
            !.git/
            
      # 2ï¸âƒ£ Cache de dependÃªncias para Python e Node
      - name: ğŸ—„ï¸ Restore dependencies cache
        uses: actions/cache@v3
        id: cache
        with:
          path: |
            ~/.cache/pip
            ~/.npm
            node_modules
          key: ${{ runner.os }}-${{ matrix.setup }}-${{ hashFiles('**/requirements.txt') }}-${{ hashFiles('**/package-lock.json') }}
          
      # 3ï¸âƒ£ ConfiguraÃ§Ã£o paralela de ambientes
      - name: ğŸ Set up Python (if needed)
        if: matrix.setup == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # Habilita cache automÃ¡tico
          
      - name: ğŸ“¦ Install Python dependencies
        if: matrix.setup == 'python'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: âš™ï¸ Run downloads_files.py
        if: matrix.setup == 'python'
        run: |
          python downloads_files.py
          cat downloaded_files.txt
          
      - name: â” Set up Node.js (if needed)
        if: matrix.setup == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“Š Generate metadata (Turbo)
        if: matrix.setup == 'node'
        run: |
          npm install # Se houver dependÃªncias
          node --max-old-space-size=4096 generate_metadata.js
          ls -lh files_metadata.json*
          
      # 4ï¸âƒ£ OtimizaÃ§Ã£o de assets
      - name: ğŸ–¼ï¸ Optimize assets
        run: |
          sudo apt-get update
          sudo apt-get install -y jpegoptim optipng pngquant gifsicle webp
          
          # Otimiza imagens (execuÃ§Ã£o em paralelo)
          find . -type f \( -iname "*.jpg" -o -iname "*.jpeg" \) -print0 | \
            xargs -0 -P4 -I{} jpegoptim --strip-all --max=90 {}
          find . -type f -iname "*.png" -print0 | \
            xargs -0 -P4 -I{} optipng -o2 -strip all {}
            
      # 5ï¸âƒ£ ConfiguraÃ§Ã£o do GitHub Pages (otimizada)
      - name: âš™ï¸ Setup GitHub Pages
        uses: actions/configure-pages@v4
        with:
          static_site_generator: "custom"  # Modo customizado para melhor performance
          
      # 6ï¸âƒ£ Upload otimizado com exclusÃ£o de arquivos desnecessÃ¡rios
      - name: ğŸ“¤ Upload artifact (Turbo)
        uses: actions/upload-pages-artifact@v3
        with:
          path: |
            .
            !.github/
            !node_modules/
            !*.log
            !*.tmp
            !generate_metadata.js
            !downloads_files.py
          compression-level: 9  # MÃ¡xima compressÃ£o
          
      # 7ï¸âƒ£ Deploy com rollback automÃ¡tico em caso de falha
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        timeout-minutes: 5  # Timeout reduzido para fail-fast
        continue-on-error: false
          
      # 8ï¸âƒ£ NotificaÃ§Ã£o de status
      - name: ğŸ“¢ Notify deployment status
        if: always()
        run: |
          if ${{ success() }}; then
            echo "âœ… Deploy realizado com sucesso!"
            echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
          else
            echo "âŒ Falha no deploy!"
            echo "ğŸ” Verifique os logs para detalhes"
          fi
          
      # 9ï¸âƒ£ Limpeza pÃ³s-deploy
      - name: ğŸ§¹ Clean up workspace
        if: always()
        run: |
          rm -rf node_modules
          rm -rf __pycache__
          rm -f *.tmp
          echo "Workspace limpo!"
